{"code":{"__map":true,"values":[["1","    const {h, html, render} = import(\"./preact.standalone.module.js\");\n    const {stringify, parse} = import (\"./stable-stringify.js\");\n\n    (() => {\n        const renkon = document.createElement(\"div\");\n        renkon.id = \"renkon\";\n        renkon.innerHTML = `\n<div id=\"buttonBox\">\n   <button class=\"menuButton\" id=\"addCodeButton\">code</button>\n   <button class=\"menuButton\" id=\"addRunnerButton\">runner</button>\n   <div class=\"spacer\"></div>\n   <button class=\"menuButton\" id=\"showGraph\">show graph</button>\n   <button class=\"menuButton\" id=\"saveButton\">save</button>\n   <button class=\"menuButton\" id=\"loadButton\">load</button>\n</div>\n<div id=\"pad\"></div>\n<div id=\"overlay\"></div>\n`;\n\n        document.body.querySelector(\"#renkon\")?.remove();\n        document.body.appendChild(renkon);\n    })();\n\n"],["3","    const addCode = Events.listener(\"#addCodeButton\", \"click\", () => \"code\");\n    const addRunner = Events.listener(\"#addRunnerButton\", \"click\", () => \"runner\");\n    const save = Events.listener(\"#saveButton\", \"click\", (evt) => evt);\n    const load = Events.listener(\"#loadButton\", \"click\", (evt) => evt);\n\n    const showGraph = Behaviors.collect(\n        true,\n        Events.listener(\"#showGraph\", \"click\", (evt) => evt),\n        (now, _click) => !now\n    );\n\n    document.querySelector(\"#showGraph\").textContent = showGraph ? \"show graph\" : \"hide graph\";\n\n    const _onRun = ((runRequest, windowContents) => {\n        const id = runRequest.id;\n        const iframe = windowContents.map.get(id);\n        const code = [...windowContents.map.values()]\n            .filter((obj) => obj.state)\n            .map((editor) => editor.state.doc.toString());\n        iframe.dom.contentWindow.postMessage({code: code, path: id});\n    })(runRequest, windowContents);\n\n    const remove = Events.receiver();\n    const titleEditChange = Events.receiver();\n    const runRequest = Events.receiver();\n\n    const padDown = Events.listener(\"#pad\", \"pointerdown\", (evt) => {\n        const strId = evt.target.id;\n        if (!strId) {return;}\n        const id = `${Number.parseInt(strId)}`;\n        let type;\n        if (strId.endsWith(\"-win\")) {\n            type = \"moveDown\";\n        } else if (strId.endsWith(\"-resize\")) {\n            type = \"windowResizeDown\";\n        }\n        if (type) {\n            evt.target.setPointerCapture(evt.pointerId);\n            return {id, target: evt.target, type, x: evt.clientX, y: evt.clientY};\n        }\n    });\n\n    const padUp = Events.listener(\"#pad\", \"pointerup\", (evt) => {\n        evt.target.releasePointerCapture(evt.pointerId);\n        return {type: \"pointerup\", x: evt.clientX, y: evt.clientY};\n    });\n\n    const downOrUpOrResize = Events.or(padDown, padUp, windowResize);\n\n    const _padMove = Events.listener(\"#pad\", \"pointermove\", moveCompute);\n\n    const windowResize = Events.receiver();\n    const moveOrResize = Events.receiver();\n\n    const moveCompute = ((downOrUpOrResize, positions) => {\n        // console.log(\"moveCompute\", downOrUpOrResize, positions);\n        if (downOrUpOrResize.type === \"moveDown\" || downOrUpOrResize.type === \"windowResizeDown\") {\n            const start = positions.map.get(downOrUpOrResize.id);\n            const downPoint = {x: downOrUpOrResize.x, y: downOrUpOrResize.y};\n            const type = downOrUpOrResize.type === \"moveDown\" ? \"move\" : \"resize\";\n            return (move) => {\n                // console.log(\"pointermove\", downOrUpOrResize, start);\n                const diffX = move.clientX - downPoint.x;\n                const diffY = move.clientY - downPoint.y;\n                const result = {id: downOrUpOrResize.id, type};\n                if (type === \"move\") {\n                    result.x = start.x + diffX;\n                    result.y = start.y + diffY;\n                } else {\n                    result.width = start.width + diffX;\n                    result.height = start.height + diffY;\n                }\n                Events.send(moveOrResize, result);\n            }\n        } else if (downOrUpOrResize.type === \"pointerup\") {\n            return null;\n        }\n    })(downOrUpOrResize, positions);\n\n    const inputHandler = (evt) => {\n        if (evt.key === \"Enter\") {\n            evt.preventDefault();\n            evt.stopPropagation();\n            Events.send(titleEditChange, {\n                id: `${Number.parseInt(evt.target.id)}`,\n                title: evt.target.textContent,\n                state: false\n            });\n        }\n    };\n\n"],["4","    const windowDOM = (id, position, zIndex, title, windowContent, type) => {\n        // console.log(\"windowDOM\");\n        return h(\"div\", {\n            key: `${id}`,\n            id: `${id}-win`,\n            \"class\": \"window\",\n            style: {\n                left: `${position.x}px`,\n                top: `${position.y}px`,\n                width: `${position.width}px`,\n                height: `${position.height}px`,\n                zIndex: `${zIndex}`,\n            },\n            ref: (ref) => {\n                if (ref) {\n                    if (ref !== windowContent.dom.parentNode) {\n                        ref.appendChild(windowContent.dom);\n                    }\n                }\n            },\n            onPointerEnter: (evt) => Events.send(hovered, `${Number.parseInt(evt.target.id)}`),\n            onPointerLeave: (_evt) => Events.send(hovered, null)\n        }, [\n            h(\"div\", {\n                id: `${id}-titleBar`,\n                \"class\": \"titleBar\",\n            }, [\n                h(\"div\", {\n                    id: `${id}-runButton`,\n                    \"class\": \"titlebarButton runButton\",\n                    type,\n                    onClick: (evt) => {\n                        //console.log(evt);\n                        Events.send(runRequest, {id: `${Number.parseInt(evt.target.id)}`});\n                    },\n                }),\n                h(\"div\", {\n                    id: `${id}-title`,\n                    \"class\": \"title\",\n                    contentEditable: `${title.state}`,\n                    onKeydown: inputHandler,\n                }, title.title),\n                h(\"div\", {\n                    id: `${id}-edit`,\n                    \"class\": `titlebarButton editButton`,\n                    onClick: (evt) => {\n                        // console.log(evt);\n                        Events.send(titleEditChange, {id: `${Number.parseInt(evt.target.id)}`, state: !title.state});\n                    },\n                }, []),\n                h(\"div\", {\n                    id: `${id}-close`,\n                    \"class\": \"titlebarButton closeButton\",\n                    onClick: (evt) => {\n                        Events.send(remove, {id: `${Number.parseInt(evt.target.id)}`, type: \"remove\"})\n                    }\n                }),\n            ]),\n            h(\"div\", {\n                id: `${id}-resize`,\n                \"class\": \"resizeHandler\",\n            }, [])\n        ])\n    };\n\n    const windowElements = ((windows, positions, zIndex, titles, windowContents, windowTypes) => {\n        return h(\"div\", {\"class\": \"owner\"}, windows.map((id) => {\n            return windowDOM(id, positions.map.get(id), zIndex.map.get(id), titles.map.get(id), windowContents.map.get(id), windowTypes.map.get(id));\n        }));\n    })(windows, positions, zIndex, titles, windowContents, windowTypes);\n\n    const _windowRender = render(windowElements, document.querySelector(\"#pad\"));\n"],["5","    const loadRequest = Events.receiver();\n\n    const _saver = ((windows, positions, zIndex, titles, windowContents, windowTypes) => {\n        const code = new Map([...windowContents.map].filter(([_id, editor]) => editor.state).map(([id, editor]) => ([id, editor.state.doc.toString()])));\n        const data = stringify({\n            version: 1,\n            windows,\n            positions,\n            zIndex,\n            titles,\n            code,\n            windowTypes\n        });\n\n        const div = document.createElement(\"a\");\n        const dataStr = \"data:text/json;charset=utf-8,\" + encodeURIComponent(data);\n        div.setAttribute(\"href\", dataStr);\n        div.setAttribute(\"download\", `renkon-pad.json`);\n        div.click();\n    })(windows, positions, zIndex, titles, windowContents, windowTypes, save);\n\n    const _loader = (() => {\n        const input = document.createElement(\"div\");\n        input.innerHTML = `<input id=\"imageinput\" type=\"file\" accept=\"application/json\">`;\n        const imageInput = input.firstChild;\n\n        imageInput.onchange = () => {\n            const file = imageInput.files[0];\n            if (!file) {imageInput.remove(); return;}\n            new Promise(resolve => {\n                let reader = new FileReader();\n                reader.onload = () => resolve(reader.result);\n                reader.readAsArrayBuffer(file);\n            }).then((data) => {\n                const result = new TextDecoder(\"utf-8\").decode(data);\n                const loaded = parse(result);\n                if (loaded.version === 1) {\n                    Events.send(loadRequest, loaded);\n                }\n                imageInput.remove();\n            });\n            imageInput.value = \"\";\n        };\n        imageInput.oncancel = () => imageInput.remove();\n        document.body.appendChild(imageInput);\n        imageInput.click();\n    })(load);\n\n    const nameFromUrl = (() => {\n        const maybeUrl = new URL(window.location).searchParams.get(\"file\");\n        if (maybeUrl) {\n            return maybeUrl;\n        }\n        return undefined;\n    })();\n\n    const _loadFromUrl = fetch(nameFromUrl).then((resp) => resp.text()).then((text) => {\n        const data = parse(text);\n        Events.send(loadRequest, data);\n    });\n"],["6","    const css = `\nhtml, body, #renkon {\n    overflow: hidden;\n    height: 100%;\n}\n\n#renkon {\n    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANEAAADRCAYAAABSOlfvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAmpJREFUeNrs3bFthEAQQFGwXIA78JVACetK3AoduIarhCvBJZBsfh3gWYnAe9iOHIzQe9KIdDXw0V3EMCRSa11iysDjXjZbOOxkbpPhLE9uB4gIRAQiAhEBIgIRgYhARICIQEQgIhARICIQEYgIRASICEQEIgIRASICEYGIQESAiEBEICIQESAiEBGICEQEiAj+1dg+8ZjoPFPMGnN3azol5mYNnct+XTNEVBIt5iPmGvPpGem0F92bNXTe9+vVKr7x4eNf9+LDx8ed+PAxnIWIQEQgIhARiAgQEYgIRAQiAkQEIgIRgYgAEYGIQEQgIkBEICIQEYgIEBGICEQEIgJEBCICEYGIABGBiEBEICJARCAiEBGICBARiAhEBCICRAQiAhGBiEBEgIhARCAiEBEgIhARiAhEBIgIRAQiAhEBIgIRgYhARICIQEQgIhAR8Lex1rpZA5xEBL3EFJs47MWL7riTuY2fc+A/ESAiEBGICEQEIgJEBCICEYGIABGBiEBEICJARCAiEBGICBARiAhEBCICRAQiAhGBiAARgYhARCAiQEQgIhARiAgQEYgIRAQiAkQEIgIRgYgAEYGIQEQgIhARICIQEYgIRASICEQEIgIRASICEYGIQESAiEBEICIQESAiEBGICE7vudZaEp3nJWaKM7kzD5Ldpwxes+xljEMsiRYzxawxd89Ipz0oN2voXPbrahX923bxxv1xL5stHHYyt/GfCE5ARCAiEBGICEQEiAhEBCICEQEiAhGBiEBEgIhARCAiEBEgIhARiAhEBIgIRAQiAhEBIgIRgYhARICIQESQ0JcAAwDLXWiRCFyTrQAAAABJRU5ErkJggg==');\n}    \n\n#pad {\n    width: 100%;\n    height: 0px;\n    position: absolute;\n    top: 30px;\n    left: 0px;\n}\n\n.owner {\n    width: 100%;\n    height: 100%;\n}\n\n.editor {\n    height: calc(100% - 24px);\n    border-radius: 0px 0px 6px 6px;\n}\n\n#overlay {\n    pointer-events: none;\n    height: 100%;\n    width: 100%;\n    position: absolute;\n    top: 30px;\n    left: 0px;\n    z-index: 10000;\n}\n\n.window {\n    position: absolute;\n    background-color: #eee;\n    border-radius: 6px;\n    box-shadow: inset 0 2px 2px 0 rgba(255, 255, 255, 0.8), 1px 1px 8px 0 rgba(0, 35, 46, 0.2);\n}\n\n#buttonBox {\n    display: flex;\n    left: 0px;\n    top: 0px;\n    width: 100%;\n    padding-bottom: 8px;\n    padding-top: 8px;\n    border-bottom: 1px solid black;\n    background-color: white;\n}\n\n.spacer {\n    flex-grow: 1;\n}\n\n.menuButton {\n    margin-left: 4px;\n    margin-right: 4px;\n    border-radius: 4px;\n}\n\t\t   \n\n.runnerIframe {\n    width: 100%;\n    height: calc(100% - 24px);\n    border-radius: 0px 0px 6px 6px;\n    border: 2px solid black;\n    box-sizing: border-box;\n    border-radius: 0px 0px 6px 6px;\n    background-color: #fff;\n    user-select: none;\n}\n\n.titleBar {\n    background-color: #bbb;\n    pointer-events: none;\n    width: 100%;\n    height: 24px;\n    display: flex;\n    border: 2px ridge #ccc;\n    box-sizing: border-box;\n    border-radius: 6px 6px 0px 0px;\n}\n\n.title {\n    pointer-events: none;\n    margin-left: 20px;\n    flex-grow: 1;\n    margin-right: 20px;\n    padding-left: 10px;\n    pointer-events: none;\n    user-select: none;\n}\n\n.title[contentEditable=\"true\"] {\n    background-color: #eee;\n    pointer-events: all;\n}\n\n.titlebarButton {\n    height: 17px;\n    width: 17px;\n    margin: 2px;\n    margin-top: 2px;\n    pointer-events: all;\n    border-radius: 8px;\n    background-position: center;\n}\n\n.titlebarButton:hover {\n    background-color: #eee;\n}\n\n.closeButton {\n    background-image: url(\"data:image/svg+xml,%3Csvg%20id%3D%22Layer_1%22%20data-name%3D%22Layer%201%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M8.48%2C12.25C6.4%2C10.17%2C4.37%2C8.16%2C2.35%2C6.15c-.34-.34-.68-.69-1-1.05a2.34%2C2.34%2C0%2C0%2C1%2C.17-3.26%2C2.3%2C2.3%2C0%2C0%2C1%2C3.25-.09C7%2C3.93%2C9.23%2C6.14%2C11.45%2C8.34a5.83%2C5.83%2C0%2C0%2C1%2C.43.58c.36-.4.62-.71.9-1%2C2-2%2C4.12-4%2C6.12-6.08a2.51%2C2.51%2C0%2C0%2C1%2C3.41%2C0%2C2.37%2C2.37%2C0%2C0%2C1%2C0%2C3.43c-2.18%2C2.22-4.39%2C4.41-6.58%2C6.62-.11.1-.21.22-.34.35l.44.48L22.09%2C19A2.7%2C2.7%2C0%2C0%2C1%2C23%2C20.56a2.49%2C2.49%2C0%2C0%2C1-1.29%2C2.54A2.36%2C2.36%2C0%2C0%2C1%2C19%2C22.69c-2-2-4-4-6.06-6-.33-.33-.62-.68-1-1.12-1.63%2C1.66-3.17%2C3.25-4.73%2C4.82-.79.8-1.6%2C1.59-2.42%2C2.36a2.32%2C2.32%2C0%2C0%2C1-3.21-.1%2C2.3%2C2.3%2C0%2C0%2C1-.19-3.25c2.14-2.2%2C4.31-4.36%2C6.48-6.54Z%22%20fill%3D%22%234D4D4D%22%2F%3E%3C%2Fsvg%3E\");\n}\n\n.editButton {\n    background-image: url(\"data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20width%3D%2224px%22%20height%3D%2224px%22%20viewBox%3D%220%200%2024%2024%22%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%3C!--%20Generator%3A%20Sketch%2064%20(93537)%20-%20https%3A%2F%2Fsketch.com%20--%3E%3Ctitle%3Eicon%2Fmaterial%2Fedit%3C%2Ftitle%3E%3Cdesc%3ECreated%20with%20Sketch.%3C%2Fdesc%3E%3Cg%20id%3D%22icon%2Fmaterial%2Fedit%22%20stroke%3D%22none%22%20stroke-width%3D%221%22%20fill%3D%22none%22%20fill-rule%3D%22evenodd%22%3E%3Cg%20id%3D%22ic-round-edit%22%3E%3Cg%20id%3D%22Icon%22%20fill%3D%22%234D4D4D%22%3E%3Cpath%20d%3D%22M3%2C17.46%20L3%2C20.5%20C3%2C20.78%203.22%2C21%203.5%2C21%20L6.54%2C21%20C6.67%2C21%206.8%2C20.95%206.89%2C20.85%20L17.81%2C9.94%20L14.06%2C6.19%20L3.15%2C17.1%20C3.05%2C17.2%203%2C17.32%203%2C17.46%20Z%20M20.71%2C7.04%20C20.8972281%2C6.85315541%2021.002444%2C6.59950947%2021.002444%2C6.335%20C21.002444%2C6.07049053%2020.8972281%2C5.81684459%2020.71%2C5.63%20L18.37%2C3.29%20C18.1831554%2C3.10277191%2017.9295095%2C2.99755597%2017.665%2C2.99755597%20C17.4004905%2C2.99755597%2017.1468446%2C3.10277191%2016.96%2C3.29%20L15.13%2C5.12%20L18.88%2C8.87%20L20.71%2C7.04%20Z%22%20id%3D%22Icon-Shape%22%3E%3C%2Fpath%3E%3C%2Fg%3E%3Crect%20id%3D%22ViewBox%22%20fill-rule%3D%22nonzero%22%20x%3D%220%22%20y%3D%220%22%20width%3D%2224%22%20height%3D%2224%22%3E%3C%2Frect%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E\");\n}\n\n.runButton {\n    background-image: url(\"data:image/svg+xml,%3Csvg%20id%3D%22Layer_1%22%20data-name%3D%22Layer%201%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M12.32%2C19.94c-2.36-.11-4.67-.17-7-.34-1.91-.14-2.65-.91-2.89-2.91a29.26%2C29.26%2C0%2C0%2C1%2C.09-8.2A2.63%2C2.63%2C0%2C0%2C1%2C5.11%2C6.11%2C102.77%2C102.77%2C0%2C0%2C1%2C18.59%2C6a8.52%2C8.52%2C0%2C0%2C1%2C1.12.12C21.15%2C6.38%2C21.88%2C7.2%2C22.1%2C9A29.32%2C29.32%2C0%2C0%2C1%2C22%2C17.19a2.58%2C2.58%2C0%2C0%2C1-2.59%2C2.4C17%2C19.73%2C14.66%2C19.82%2C12.32%2C19.94Zm-2.06-4.05%2C5.29-3-5.29-3Z%22%20fill%3D%22%234D4D4D%22%2F%3E%3C%2Fsvg%3E\");\n    display: none;\n    pointer-events: none;\n}\n\n.runButton[type=\"runner\"] {\n    display: inherit;\n    pointer-events: all;\n}\n\n.resizeHandler {\n    position: absolute;\n    background-color: rgba(0.1, 0.1, 0.1, 0.1);\n    width: 20px;\n    height: 20px;\n    bottom: -10px;\n    right: -10px;\n    border-radius: 6px;\n}\n\n.resizeHandler:hover {\n    background-color: rgba(0.1, 0.4, 0.1, 0.3);\n}\n`;\n\n    ((css) => {\n        const renkon = document.querySelector(\"#renkon\");\n        const style = document.createElement(\"style\");\n        style.id = \"pad-css\";\n        style.textContent = css;\n        renkon.querySelector(\"#pad-css\")?.remove();\n        renkon.appendChild(style);\n    })(css);\n"],["7","    const analyzed = ((windowContents, trigger, showGraph) => {\n        if (!showGraph) {return new Map()}\n        if (trigger === null) {return new Map()}\n        if (typeof trigger === \"object\" && trigger.id) {return new Map();}\n\n        const programState = new Renkon.constructor(0);\n        programState.setLog(() => {});\n\n        const code = [...windowContents.map].filter(([_id, editor]) => editor.state).map(([id, editor]) => ({blockId: id, code: editor.state.doc.toString()}));\n        try {\n            programState.setupProgram(code);\n        } catch(e) {\n            console.log(\"Graph analyzer encountered an error in source code:\");\n            return new Map();\n        }\n\n        const nodes = new Map();\n        for (let jsNode of programState.nodes.values()) {\n            let ary = nodes.get(jsNode.blockId);\n            if (!ary) {\n                ary = [];\n                nodes.set(jsNode.blockId, ary);\n            }\n            ary.push({inputs: jsNode.inputs, outputs: jsNode.outputs});\n        }\n\n        const exportedNames = new Map();\n        const importedNames = new Map();\n        for (let [id, subNodes] of nodes) {\n            const exSet = new Set();\n            exportedNames.set(id, exSet);\n\n            const inSet = new Set();\n            importedNames.set(id, inSet);\n\n            for (let subNode of subNodes) {\n                let outputs = subNode.outputs;\n                if (outputs.length > 0 && !/^_[0-9]/.exec(outputs)) {\n                    exSet.add(outputs);\n                }\n                for (let inString of subNode.inputs) {\n                    if (!/^_[0-9]/.exec(inString)) {\n                        inSet.add(inString);\n                    }\n                }\n            }\n        }\n\n        // {edgesOut: [{id: \"defined name\", dest: '2'}, ...],\n        //  edgesIn: [{id: \"defined name\", origin: '2'}, ...]}\n        const edges = new Map();\n\n        for (let [id, _] of nodes) {\n            const exporteds = exportedNames.get(id);\n            const importeds = importedNames.get(id);\n\n            const edgesOut = [];\n            const edgesIn = [];\n            const exports = new Set();\n\n            for (let exported of exporteds) {\n                for (let [destId, destSet] of importedNames) {\n                    if (destSet.has(exported) && id !== destId) {\n                        edgesOut.push({id: exported, dest: destId});\n                        exports.add(exported);\n                    }\n                }\n            }\n            for (let imported of importeds) {\n                for (let [sourceId, sourceSet] of exportedNames) {\n                    if (sourceSet.has(imported) && id !== sourceId) {\n                        edgesIn.push({id: imported, origin: sourceId});\n                    }\n                }\n            }\n            edges.set(id, {edgesOut, edgesIn, exports: [...exports]});\n        }\n\n        return edges;\n    })(windowContents, Events.or(remove, hovered), showGraph);\n\n    const line = (p1, p2, color, label) => {\n        let pl;\n        let pr;\n        if (p1.x < p2.x) {\n            pl = p1;\n            pr = p2;\n        } else {\n            pl = p2;\n            pr = p1;\n        }\n        const c0 = `${pl.x} ${pl.y}`;\n        const c1 = `${pl.x + (pr.x - pl.x) * 0.5} ${pl.y + (pr.y - pl.y) * 0.2}`;\n        const c2 = `${pr.x - (pr.x - pl.x) * 0.2} ${pl.y + (pr.y - pl.y) * 0.6}`;\n        const c3 = `${pr.x} ${pr.y}`;\n        return html`<path d=\"M ${c0} C ${c1} ${c2} ${c3}\" stroke=\"${color}\" fill=\"transparent\" stroke-width=\"2\" stroke-linecap=\"round\"></path><text x=\"${p1.x + 5}\" y=\"${p1.y}\">${label}</text>`;\n    };\n\n    const hovered = Events.receiver();\n    const hoveredB = Behaviors.keep(hovered);\n\n    const graph = ((positions, analyzed, hoveredB, showGraph) => {\n        if (hoveredB === null) {return [];}\n        if (!showGraph) {return [];}\n\n        const edges = analyzed.get(hoveredB);\n\n        if (!edges) {return [];} // runner does not have edges\n\n        const outEdges = edges.edgesOut.map((edge) => {\n            const ind = edges.exports.indexOf(edge.id);\n            let p1 = positions.map.get(hoveredB);\n            p1 = {x: p1.x + p1.width, y: p1.y};\n            p1 = {x: p1.x, y: p1.y + ind * 20 + 10};\n            let p2 = positions.map.get(edge.dest);\n            p2 = {x: p2.x, y: p2.y + 10};\n            return line(p1, p2, \"#d88\", edge.id);\n        });\n\n        const inEdges = edges.edgesIn.map((edge) => {\n            const exporter = analyzed.get(edge.origin);\n            const ind = exporter.exports.indexOf(edge.id);\n            let p1 = positions.map.get(edge.origin);\n            p1 = {x: p1.x + p1.width, y: p1.y};\n            p1 = {x: p1.x, y: p1.y + ind * 20 + 10};\n            let p2 = positions.map.get(hoveredB);\n            p2 = {x: p2.x, y: p2.y + 10};\n            return line(p1, p2, \"#88d\", edge.id);\n        });\n\n        return html`<svg viewBox=\"0 0 ${window.innerWidth} ${window.innerHeight}\" xmlns=\"http://www.w3.org/2000/svg\">${outEdges}${inEdges}</svg>`;\n    })(positions, analyzed, hoveredB, showGraph);\n\n    const _graphRender = render(graph, document.querySelector(\"#overlay\"));\n"],["9","    // [id:string]\n    const windows = Behaviors.select(\n        [],\n        loadRequest, (now, data) => {\n            console.log(\"windows loaded\");\n            return data.windows\n        },\n        newWindowRequest, (now, spec) => [...now, `${spec.id}`],\n        remove, (now, removeCommand) => now.filter((e) => e != removeCommand.id),\n    );\n\n    // {map: Map<id, type:\"code\"|\"runner\">\n    const windowTypes = Behaviors.select(\n        {map: new Map()},\n        loadRequest, (now, data) => {\n            console.log(\"windowTypes loaded\");\n            return data.windowTypes;\n        },\n        newWindowRequest, (now, spec) => {\n            now.map.set(`${spec.id}`, spec.type);\n            return {map: now.map};\n        },\n        Events.change(windows), (now, windows) => {\n            const keys = [...now.map.keys()];\n            const news = windows.filter((e) => !keys.includes(e));\n            const olds = keys.filter((e) => !windows.includes(e));\n\n            olds.forEach((id) => now.map.delete(`${id}`));\n            news.forEach((id) => now.map.set(`${id}`, \"code\"));\n            return {map: now.map};\n        }\n    );\n\n    // {id, x: number, y: number, width: number, height: number}\n    const positions = Behaviors.select(\n        {map: new Map()},\n        loadRequest, (now, data) => {\n            console.log(\"positions loaded\");\n            return data.positions\n        },\n        Events.change(windowTypes), (now, types) => {\n            const keys = [...now.map.keys()];\n            const typeKeys = [...types.map.keys()];\n            const news = typeKeys.filter((e) => !keys.includes(e));\n            const olds = keys.filter((e) => !typeKeys.includes(e));\n\n            const newWindow = (id, type) => {\n                return {\n                    id,\n                    x: typeKeys.length * 30,\n                    y: typeKeys.length * 30 + 30,\n                    width: type === \"code\" ? 300 : 800,\n                    height: type === \"code\" ? 200 : 400\n                }\n            };\n            olds.forEach((id) => now.map.delete(`${id}`));\n            news.forEach((id) => now.map.set(`${id}`, newWindow(id, types.map.get(id))));\n            return {map: now.map};\n        },\n        moveOrResize, (now, command) => {\n            if (command.type === \"move\" || command.type === \"resize\") {\n                const v = {...now.map.get(command.id), ...command};\n                v.width = Math.max(120, v.width);\n                v.height = Math.max(120, v.height);\n                now.map.set(command.id, v);\n                return {map: now.map};\n            }\n            return now;\n        },\n    );\n\n    const findMax = (map)  => {\n        let maxId = -1;\n        let max = -1;\n        for (let [id, value] of map) {\n            if (value > max) {\n                maxId = id;\n                max = value;\n            }\n        }\n        return {maxId, max};\n    };\n\n    const zIndex = Behaviors.select(\n        {map: new Map()},\n        loadRequest, (now, data) => {\n            console.log(\"zIndex loaded\");\n            if (data.zIndex) return data.zIndex;\n            return {map: new Map(data.windows.map((w, i) => [w, i + 100]))};\n        },\n        Events.change(windows), (now, command) => {\n            const keys = [...now.map.keys()];\n            const news = command.filter((e) => !keys.includes(e));\n            const olds = keys.filter((e) => !command.includes(e));\n\n            const {maxId:_maxId, max} = findMax(now.map);\n            let z = max < 0 ? 100 : max + 1;\n            olds.forEach((id) => now.map.delete(id));\n            news.forEach((id) => now.map.set(id, z++));\n            return {map: now.map};\n        },\n        moveOrResize, (now, command) => {\n            if (command.type === \"move\") {\n                const z = now.map.get(command.id);\n\n                const {maxId, max} = findMax(now.map);\n                if (maxId !== command.id) {\n                    now.map.set(maxId, z);\n                    now.map.set(command.id, max);\n                }\n                return {map: now.map};\n            }\n            return now\n        },\n    );\n\n    const titles = Behaviors.select(\n        {map: new Map()},\n        loadRequest, (now, loaded) => {\n            console.log(\"titles loaded\");\n            return loaded.titles || {map: new Map()};\n        },\n        Events.change(windows), (now, command) => {\n            const keys = [...now.map.keys()];\n            const news = command.filter((e) => !keys.includes(e));\n            const olds = keys.filter((e) => !command.includes(e));\n\n            olds.forEach((id) => now.map.delete(id));\n            news.forEach((id) => now.map.set(id, {id, state: false, title: \"untitled\"}));\n            return {map: now.map};\n        },\n        titleEditChange, (now, change) => {\n            const id = change.id;\n            const v = {...now.map.get(id), ...change};\n            now.map.set(id, v);\n            return {map: now.map};\n        }\n    );\n\n    const windowContents = Behaviors.select(\n        {map: new Map()},\n        loadRequest, (now, loaded) => {\n            for (let editor of now.map.values()) {\n                editor.dom.remove();\n            }\n            now.map.clear();\n\n            for (let [id, type] of loaded.windowTypes.map) {\n                let elem;\n                if (type === \"code\") {\n                    elem = newEditor(id, loaded.code.get(id));\n                } else {\n                    elem = newRunner(id);\n                }\n                now.map.set(id, elem);\n            }\n            return {map: now.map};\n        },\n        Events.change(windowTypes), (now, types) => {\n            const keys = [...now.map.keys()];\n            const typeKeys = [...types.map.keys()];\n            const news = typeKeys.filter((e) => !keys.includes(e));\n            const olds = keys.filter((e) => !typeKeys.includes(e));\n            olds.forEach((id) => {\n                const editor = now.map.get(id);\n                editor.dom.remove();\n                now.map.delete(id)\n            });\n            news.forEach((id) => {\n                const type = types.map.get(id);\n                now.map.set(id, type === \"code\" ? newEditor(id) : newRunner(id));\n            });\n            return {map: now.map};\n        }\n    );\n\n    const init = Events.once(\"code\");\n\n    const newId = Events.select(\n        0,\n        loadRequest, (now, request) => {\n            const max = Math.max(...request.windows.map((w) => Number.parseInt(w)));\n            return max;\n        },\n        Events.or(addCode, addRunner, init), (now, _type) => now + 1\n    );\n\n    const newWindowRequest = Events.change({id: newId, type: Events.or(addCode, addRunner, init)});\n\n    const newEditor = (id, doc) => {\n        const mirror = window.CodeMirror;\n        const editor = new mirror.EditorView({\n            doc: doc || `console.log(\"hello\")`,\n            extensions: [\n                mirror.basicSetup,\n                mirror.EditorView.lineWrapping,\n                mirror.EditorView.editorAttributes.of({\"class\": \"editor\"}),\n                mirror.keymap.of([mirror.indentWithTab])\n            ],\n        });\n        editor.dom.id = `${id}-editor`;\n        return editor;\n    };\n\n    const newRunner = (id) => {\n        const runnerIframe = document.createElement(\"iframe\");\n        runnerIframe.srcdoc = `\n<!DOCTYPE html>\n<html>\n    <head>\n        <meta charset=\"utf-8\">\n    </head>\n    <body>\n        <div id=\"renkon\">\n        </div>\n        <script type=\"module\">\n            import {ProgramState, CodeMirror} from \"./renkon-web.js\";\n            window.thisProgramState = new ProgramState(0);\n            window.CodeMirror = CodeMirror;\n\n            window.onmessage = (evt) => {\n                if (evt.data && Array.isArray(evt.data.code)) {\n                    window.thisProgramState.updateProgram(evt.data.code, evt.data.path);\n                    if (window.thisProgramState.evaluatorRunning === 0) {\n                        window.thisProgramState.evaluator();\n                    }\n                }\n            };\n        </script>\n    </body>\n</html>`;\n        runnerIframe.classList = \"runnerIframe\";\n        runnerIframe.id = `runner-${id}`;\n        return {dom: runnerIframe};\n    };\n"]]},"positions":{"map":{"__map":true,"values":[["1",{"height":451.1484375,"id":"1","type":"resize","width":501.87109375,"x":24.71484375,"y":29.15234375}],["3",{"height":233.33984375,"id":"3","type":"resize","width":502.1171875,"x":521.24609375,"y":251.48828125}],["4",{"height":155.01953125,"id":"4","type":"move","width":429.08203125,"x":1066.97265625,"y":512.921875}],["5",{"height":212.45703125,"id":"5","type":"move","width":406.42578125,"x":1077.8125,"y":25.7890625}],["6",{"height":120,"id":"6","type":"move","width":430.02734375,"x":1067.28515625,"y":705.2109375}],["7",{"height":223.453125,"id":"7","type":"move","width":419.94140625,"x":1070.3671875,"y":259.34375}],["9",{"height":200.41796875,"id":"9","width":488.5546875,"x":525.9140625,"y":31.20703125}]]}},"titles":{"map":{"__map":true,"values":[["1",{"id":"1","state":false,"title":"Initialization"}],["3",{"id":"3","state":false,"title":"User Interaction"}],["4",{"id":"4","state":false,"title":"Rendering"}],["5",{"id":"5","state":false,"title":"Save and Load"}],["6",{"id":"6","state":false,"title":"CSS"}],["7",{"id":"7","state":false,"title":"Graph Visualization"}],["9",{"id":"9","state":false,"title":"Data Structure"}]]}},"version":1,"windowTypes":{"map":{"__map":true,"values":[["1","code"],["3","code"],["4","code"],["5","code"],["6","code"],["7","code"],["9","code"]]}},"windows":["1","3","4","5","6","7","9"],"zIndex":{"map":{"__map":true,"values":[["1",101],["3",100],["4",104],["5",108],["6",105],["7",107],["9",103]]}}}